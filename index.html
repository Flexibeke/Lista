<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((reg) => console.log("SW registrado:", reg))
            .catch((err) => console.error("Falha ao registrar SW:", err));
        });
      }
    </script>

    <title>Tarefas Escolar</title>
    <style>
      :root {
        --bg: #0b0f14;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --card: #111827;
        --accent: #22c55e;
        --danger: #ef4444;
        --border: #1f2937;
        --done: #3f3f3f;
      }
      .light {
        --bg: #f6f7fb;
        --fg: #0b0f14;
        --muted: #4b5563;
        --card: #fff;
        --accent: #16a34a;
        --danger: #dc2626;
        --border: #e5e7eb;
        background: var(--bg);
        color: var(--fg);
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: ui-sans-serif, system-ui;
      }
      body {
        display: grid;
        grid-template-rows: auto 1fr auto;
        background: var(--bg);
        color: var(--fg);
      }
      header {
        display: flex;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        background: var(--card);
        position: sticky;
        top: 0;
        z-index: 20;
      }
      .brand {
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .spacer {
        flex: 1;
      }
      button,
      select,
      input[type="text"],
      input[type="password"],
      input[type="date"] {
        background: var(--card);
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 14px;
      }
      button:hover {
        filter: brightness(1.04);
      }
      button:active {
        transform: translateY(1px);
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 14px;
        padding: 10px 14px;
        cursor: pointer;
      }
      .btn-primary {
        background: var(--accent);
        color: white;
        border: 0;
      }
      .btn-ghost {
        background: transparent;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
        border: 0;
      }
      .btn-done {
        background: #3f3f3f;
        color: #fff;
      }
      main {
        padding: 16px;
        padding-bottom: 96px;
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        box-sizing: border-box;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
      }
      .section-title {
        font-weight: 700;
        margin: 8px 0 12px;
      }
      .list {
        display: grid;
        gap: 10px;
        max-height: 70vh;
        overflow-y: auto;
      }
      .item {
        display: grid;
        gap: 6px;
        align-items: center;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: transparent;
        box-sizing: border-box;
      }
      .item .row-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
      }
      .item input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }
      .badge {
        font-size: 12px;
        padding: 4px 8px;
        border: 1px solid var(--border);
        border-radius: 999px;
        opacity: 0.9;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .item-title {
        font-weight: 600;
      }
      .hidden {
        display: none !important;
      }
      .nav {
        position: fixed;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 22px;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 6px;
        padding: 8px;
        width: min(700px, calc(100%-16px));
        z-index: 30;
      }
      .nav .btn {
        justify-content: center;
        width: 100%;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: transparent;
      }
      .nav .btn.active {
        background: var(--border);
      }
      .nav .fab {
        width: 54px;
        height: 54px;
        border-radius: 18px;
        display: grid;
        place-items: center;
        font-size: 28px;
        line-height: 1;
        border: 0;
        background: var(--accent);
        color: #fff;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
      }
      .overlay {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(0, 0, 0, 0.6);
        z-index: 40;
      }
      .modal {
        width: min(520px, 96%);
      }
      .grid {
        display: grid;
        gap: 10px;
      }
      .grid.cols-2 {
        grid-template-columns: 1fr 1fr;
      }
      label {
        font-size: 13px;
        color: var(--muted);
      }
      .top-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .urgente {
        background: #fca326;
        color: #fff;
      }
      .atrasada {
        background: #f28b82;
        color: #fff;
      }
      @media (max-width: 480px) {
        main {
          padding: 8px;
        }
        .item .row-item {
          flex-direction: column;
          align-items: flex-start;
        }
        .item input[type="checkbox"] {
          margin-bottom: 4px;
        }
        .badge {
          font-size: 10px;
          padding: 2px 6px;
        }
        .btn,
        .btn-primary,
        .btn-danger {
          padding: 6px 10px;
          font-size: 12px;
        }
        .nav {
          padding: 6px;
          gap: 4px;
        }
        .nav .fab {
          width: 48px;
          height: 48px;
          font-size: 24px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="row">
        <span class="brand">Tarefas Escolar</span>
        <span id="envTag" class="badge">Firebase: OFF</span>
      </div>
      <div class="top-actions">
        <button id="themeBtn" class="btn btn-ghost">ðŸŒ“</button>
        <button id="adminBtn" class="btn btn-ghost">ðŸ‘‘</button>
      </div>
    </header>

    <main>
      <section id="tab-turma" class="card">
        <div class="section-title">Tarefas da turma</div>
        <div id="turmaList" class="list"></div>
        <div id="turmaEmpty" class="muted" style="margin-top: 8px">
          Nenhuma tarefa por enquanto.
        </div>
      </section>

      <section id="tab-criar" class="card hidden">
        <div class="section-title">Criar tarefa</div>
        <div class="grid">
          <div class="grid cols-2">
            <div class="grid">
              <label>MatÃ©ria</label>
              <select id="materia">
                <option>MatemÃ¡tica</option>
                <option>PortuguÃªs</option>
                <option>CiÃªncias</option>
                <option>Geografia</option>
                <option>InglÃªs</option>
                <option>Artes</option>
                <option>EducaÃ§Ã£o FÃ­sica</option>
                <option>LÃ³gica de ProgramaÃ§Ã£o</option>
                <option>IMC</option>
                <option>ITI</option>
              </select>
            </div>
            <div class="grid">
              <label>O que Ã© para fazer</label>
              <input
                type="text"
                id="descricao"
                placeholder="Ex.: Copiar pÃ¡g.125..."
              />
            </div>
          </div>
          <div class="grid">
            <label>Data de entrega</label>
            <input type="date" id="dataEntrega" />
          </div>
          <div class="row" style="justify-content: flex-end; gap: 8px">
            <button id="criarBtn" class="btn btn-primary">Salvar tarefa</button>
          </div>
        </div>
      </section>

      <section id="tab-pessoal" class="card hidden">
        <div class="section-title">Minha Toâ€‘do List</div>
        <div class="row" style="margin-bottom: 10px; gap: 8px; flex-wrap: wrap">
          <input
            type="text"
            id="pessoalInput"
            placeholder="Nova tarefa pessoal"
            style="flex: 1 1 200px"
          />
          <select id="pessoalMateria" style="flex: 1 1 120px">
            <option>NÃ£o-escolar</option>
            <option>MatemÃ¡tica</option>
            <option>PortuguÃªs</option>
            <option>CiÃªncias</option>
            <option>Geografia</option>
            <option>InglÃªs</option>
            <option>Artes</option>
            <option>EducaÃ§Ã£o FÃ­sica</option>
            <option>LÃ³gica de ProgramaÃ§Ã£o</option>
            <option>IMC</option>
            <option>ITI</option>
          </select>
          <button id="pessoalAdd" class="btn btn-primary">Adicionar</button>
        </div>
        <div id="pessoalList" class="list"></div>
        <div id="pessoalEmpty" class="muted" style="margin-top: 8px">
          Sem tarefas pessoais.
        </div>
      </section>
    </main>

    <nav class="nav">
      <button id="btnTabTurma" class="btn active">Tarefas</button>
      <button id="btnFabCriar" class="fab hidden">+</button>
      <button id="btnTabPessoal" class="btn">Minha lista</button>
    </nav>

    <div id="senhaOverlay" class="overlay hidden">
      <div class="modal card">
        <div class="section-title">Acesso</div>
        <div class="grid">
          <label>Digite a senha de entrada</label>
          <input id="senhaInput" type="password" />
          <div class="row" style="justify-content: flex-end; gap: 8px">
            <button id="senhaOk" class="btn btn-primary">Entrar</button>
          </div>
          <div id="senhaMsg" class="muted"></div>
        </div>
      </div>
    </div>

    <div id="adminOverlay" class="overlay hidden">
      <div class="modal card">
        <div class="section-title">Entrar como Admin</div>
        <div class="grid">
          <label>Chave de admin</label>
          <input id="adminKeyInput" type="password" />
          <div class="row" style="justify-content: flex-end; gap: 8px">
            <button id="adminCancel" class="btn">Cancelar</button>
            <button id="adminOk" class="btn btn-primary">Confirmar</button>
          </div>
          <div id="adminMsg" class="muted"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
      import {
        getFirestore,
        collection,
        doc,
        getDoc,
        setDoc,
        addDoc,
        onSnapshot,
        query,
        where,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBPZTPNlTjiYZrPdrwnCB5KJ9Z4y9tM1P4",
        authDomain: "tarefas-escolares-a4464.firebaseapp.com",
        projectId: "tarefas-escolares-a4464",
        storageBucket: "tarefas-escolares-a4464.appspot.com",
        messagingSenderId: "62405653853",
        appId: "1:62405653853:web:72e28ab1aa00995be024b4",
        measurementId: "G-XZVW5G135E",
      };
      const app = initializeApp(firebaseConfig),
        analytics = getAnalytics(app),
        db = getFirestore(app);

      const $ = (s) => document.querySelector(s);
      const userId =
        localStorage.getItem("userId") ||
        "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem("userId", userId);

      document.addEventListener("DOMContentLoaded", () => {
        // theme
        const themeBtn = $("#themeBtn");
        function loadTheme() {
          document.body.classList.toggle(
            "light",
            localStorage.getItem("theme") === "light"
          );
        }
        function toggleTheme() {
          const t = document.body.classList.toggle("light");
          localStorage.setItem("theme", t ? "light" : "dark");
        }
        themeBtn.addEventListener("click", toggleTheme);
        loadTheme();

        // tabs
        const tabTurma = $("#tab-turma"),
          tabCriar = $("#tab-criar"),
          tabPessoal = $("#tab-pessoal");
        const btnTabTurma = $("#btnTabTurma"),
          btnFabCriar = $("#btnFabCriar"),
          btnTabPessoal = $("#btnTabPessoal");
        function showTab(name) {
          tabTurma.classList.toggle("hidden", name !== "turma");
          tabCriar.classList.toggle("hidden", name !== "criar");
          tabPessoal.classList.toggle("hidden", name !== "pessoal");
          btnTabTurma.classList.toggle("active", name === "turma");
          btnTabPessoal.classList.toggle("active", name === "pessoal");
        }
        btnTabTurma.addEventListener("click", () => showTab("turma"));
        btnTabPessoal.addEventListener("click", () => showTab("pessoal"));
        btnFabCriar.addEventListener("click", () => showTab("criar"));

        // admin
        const adminBtn = $("#adminBtn"),
          adminOverlay = $("#adminOverlay"),
          adminKeyInput = $("#adminKeyInput"),
          adminOk = $("#adminOk"),
          adminCancel = $("#adminCancel"),
          adminMsg = $("#adminMsg");
        function isAdmin() {
          return localStorage.getItem("isAdmin") === "true";
        }
        function setAdmin(v) {
          localStorage.setItem("isAdmin", v ? "true" : "false");
          btnFabCriar.classList.toggle("hidden", !v);
          if (!v && !tabCriar.classList.contains("hidden")) showTab("turma");
        }
        setAdmin(isAdmin());
        adminBtn.addEventListener("click", () => {
          adminKeyInput.value = "";
          adminMsg.textContent = "";
          adminOverlay.classList.remove("hidden");
        });
        adminCancel.addEventListener("click", () =>
          adminOverlay.classList.add("hidden")
        );
        adminOk.addEventListener("click", async () => {
          const key = adminKeyInput.value.trim();
          if (!key) {
            adminMsg.textContent = "Digite a chave!";
            return;
          }
          try {
            const snap = await getDoc(doc(db, "config", "app"));
            if (!snap.exists()) {
              adminMsg.textContent =
                "Documento de configuraÃ§Ã£o nÃ£o encontrado!";
              return;
            }
            const { adminKeys = [] } = snap.data();
            if (adminKeys.includes(key)) {
              setAdmin(true);
              adminOverlay.classList.add("hidden");
              alert("VocÃª agora Ã© admin!");
            } else {
              adminMsg.textContent = "Chave invÃ¡lida!";
            }
          } catch (e) {
            console.error(e);
            adminMsg.textContent = "Erro ao verificar chave!";
          }
        });

        // tarefas
        const turmaList = $("#turmaList"),
          turmaEmpty = $("#turmaEmpty");
        const pessoalList = $("#pessoalList"),
          pessoalEmpty = $("#pessoalEmpty");
        const pessoalInput = $("#pessoalInput"),
          pessoalMateria = $("#pessoalMateria"),
          pessoalAdd = $("#pessoalAdd");

        function renderTurmaItem(t, status = {}) {
          if (status.excluido) return null;
          const wrap = document.createElement("div");
          wrap.className = "item";
          const mid = document.createElement("div");
          mid.innerHTML = `<div class="item-title">${
            t.descricao
          }</div><div class="muted">${t.materia || "NÃ£o-escolar"}</div>`;
          const feitoBtn = document.createElement("button");
          feitoBtn.className = "btn";
          feitoBtn.textContent = status.feito ? "Feito" : "Marcar feito";
          feitoBtn.classList.add(status.feito ? "btn-done" : "btn-primary");
          feitoBtn.disabled = !!status.feito;
          const excluirBtn = document.createElement("button");
          excluirBtn.className = "btn btn-danger";
          excluirBtn.textContent = "Excluir";
          excluirBtn.style.display = status.feito ? "inline-flex" : "none";
          if (status.feito) wrap.style.background = "#3f3f3f";
          const entrega = t.dataEntrega
            ? new Date(t.dataEntrega.seconds * 1000 || t.dataEntrega)
            : null;
          if (entrega) {
            const hoje = new Date();
            const diffDias = Math.ceil(
              (entrega - hoje) / (1000 * 60 * 60 * 24)
            );
            if (diffDias < 0) wrap.classList.add("atrasada");
            else if (diffDias <= 3) wrap.classList.add("urgente");
          }
          feitoBtn.addEventListener("click", async () => {
            await setDoc(doc(db, "status_tarefas", `${t.id}_${userId}`), {
              tarefaId: t.id,
              usuarioId: userId,
              feito: true,
            });
            feitoBtn.disabled = true;
            feitoBtn.textContent = "Feito";
            feitoBtn.classList.remove("btn-primary");
            feitoBtn.classList.add("btn-done");
            wrap.style.background = "#3f3f3f";
            excluirBtn.style.display = "inline-flex";
          });
          excluirBtn.addEventListener("click", async () => {
            await setDoc(doc(db, "status_tarefas", `${t.id}_${userId}`), {
              tarefaId: t.id,
              usuarioId: userId,
              feito: status.feito || false,
              excluido: true,
            });
            wrap.remove();
          });
          const rowItem = document.createElement("div");
          rowItem.className = "row-item";
          rowItem.append(mid, feitoBtn, excluirBtn);
          wrap.appendChild(rowItem);
          return { wrap, entrega: entrega || new Date(0) };
        }

        function renderPessoalItem(p) {
          const wrap = document.createElement("div");
          wrap.className = "item";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = !!p.feito;
          const mid = document.createElement("div");
          mid.innerHTML = `<div class="item-title">${
            p.descricao
          }</div><div class="muted">${p.materia || "NÃ£o-escolar"}</div>`;
          const right = document.createElement("button");
          right.className = "btn btn-danger";
          right.textContent = "Excluir";
          const rowItem = document.createElement("div");
          rowItem.className = "row-item";
          rowItem.append(mid, cb, right);
          wrap.appendChild(rowItem);
          cb.addEventListener("change", async () => {
            await setDoc(doc(db, "tarefas_pessoais", p.id), {
              usuarioId: userId,
              descricao: p.descricao,
              materia: p.materia,
              feito: !!cb.checked,
            });
          });
          right.addEventListener("click", async () => {
            await setDoc(
              doc(db, "tarefas_pessoais", p.id),
              { _deleted: true },
              { merge: true }
            );
          });
          return wrap;
        }

        let unsubTurma = null,
          unsubPessoais = null;
        function bindTurma() {
          if (unsubTurma) unsubTurma();
          unsubTurma = onSnapshot(
            query(collection(db, "tarefas_turma"), orderBy("data", "desc")),
            async (snap) => {
              const tarefas = [];
              snap.forEach((d) => tarefas.push({ id: d.id, ...d.data() }));
              turmaList.innerHTML = "";
              if (!tarefas.length) {
                turmaEmpty.classList.remove("hidden");
                return;
              }
              turmaEmpty.classList.add("hidden");
              const statusSnaps = await Promise.all(
                tarefas.map((t) =>
                  getDoc(doc(db, "status_tarefas", `${t.id}_${userId}`))
                )
              );
              const statusMap = {};
              tarefas.forEach((t, i) => {
                statusMap[t.id] = statusSnaps[i].exists()
                  ? statusSnaps[i].data()
                  : {};
              });
              const wrappers = tarefas
                .map((t) => renderTurmaItem(t, statusMap[t.id]))
                .filter(Boolean);
              wrappers
                .sort((a, b) => {
                  const aAtr = a.wrap.classList.contains("atrasada")
                    ? 0
                    : a.wrap.classList.contains("urgente")
                    ? 1
                    : 2;
                  const bAtr = b.wrap.classList.contains("atrasada")
                    ? 0
                    : b.wrap.classList.contains("urgente")
                    ? 1
                    : 2;
                  if (aAtr !== bAtr) return aAtr - bAtr;
                  return a.entrega - b.entrega;
                })
                .forEach((w) => turmaList.appendChild(w.wrap));
            }
          );
        }

        function bindPessoais() {
          if (unsubPessoais) unsubPessoais();
          unsubPessoais = onSnapshot(
            query(
              collection(db, "tarefas_pessoais"),
              where("usuarioId", "==", userId)
            ),
            (snap) => {
              const items = [];
              snap.forEach((d) => {
                const data = d.data();
                if (!data._deleted) items.push({ id: d.id, ...data });
              });
              pessoalList.innerHTML = "";
              if (!items.length) {
                pessoalEmpty.classList.remove("hidden");
                return;
              }
              pessoalEmpty.classList.add("hidden");
              items.forEach((p) =>
                pessoalList.appendChild(renderPessoalItem(p))
              );
            }
          );
        }

        pessoalAdd.addEventListener("click", async () => {
          const desc = pessoalInput.value.trim();
          const materia = pessoalMateria.value;
          if (!desc) return;
          await addDoc(collection(db, "tarefas_pessoais"), {
            usuarioId: userId,
            descricao: desc,
            materia: materia,
            feito: false,
          });
          pessoalInput.value = "";
          pessoalMateria.value = "NÃ£o-escolar";
        });

        $("#criarBtn").addEventListener("click", async () => {
          const desc = $("#descricao").value.trim();
          if (!desc) {
            alert("Preencha a descriÃ§Ã£o");
            return;
          }
          const dataEntregaValue = $("#dataEntrega").value;
          await addDoc(collection(db, "tarefas_turma"), {
            descricao: desc,
            materia: $("#materia").value,
            data: new Date(),
            dataEntrega: dataEntregaValue ? new Date(dataEntregaValue) : null,
          });
          $("#descricao").value = "";
          $("#dataEntrega").value = "";
          showTab("turma");
        });

        bindTurma();
        bindPessoais();
      });
    </script>
  </body>
</html>
